<!doctype html>
<html>
<head>
<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="https://code.jquery.com/jquery-3.5.0.js"></script>
<link rel="stylesheet" type="text/css" href="multi.min.css">
<script src="multi.min.js"></script>
<link rel="stylesheet" href="rsSliderLens.css" />
<script src="jquery.rsSliderLens.js"></script>
<script>$(document).ready(function() {$('select').multi({search_placeholder: 'Hae muuttuja...',});});</script>
<style>
.container {
  font: 12px sans-serif;
  box-sizing: border-box;
  margin: 10px auto;
  max-width: 1000px;
  padding: 0 ppx;
  width: 100%;
      }
h2 { color:#fff;}

.link {
  stroke: white;
  stroke-width: 1px;
}
.licensing {
  fill: none;
}
.suit {
  fill: #0772A1;
}
.resolved {
  fill: #FF8700;
}
.node {
  fill: lightgray;
  stroke: black;
  stroke-width: 1px;
}
text {
  font: 10px sans-serif;
  pointer-events: none;
  text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff;
}
h6 { color: #7c795d; font-family: 'Source Sans Pro', sans-serif; font-size: 16px; font-weight: 400; line-height: 24px; margin: 0 0 24px; }

</style>

</head>
<body>
    <div class="container">
    <select multiple="multiple" name="statistical_areas" id="area_select" onChange="valinnat($(this).val())">
    <option value="51">1. desiilin palkat</option>
    <option value="52">9. desiilin palkat</option>
    <option value="5">Aikuisten mielenterveyden avohoitokäynnit</option>
    <option value="129">Alkoholin myynti asukasta kohden</option>
    <option value="30a">Alkutuotannon työlliset</option>
    <option value="32">Alueen SOTE -työlliset</option>
    <option value="31">Asuinkunnassaan työssäkäyvät</option>
    <option value="70">Avioliiton solmineet miehet 20-39</option>
    <option value="71">Avioliiton solmineet naiset 20-39</option>
    <option value="63">Aviopari, lapset 0-17</option>
    <option value="62">Avopari, lapset 0-17</option>
    <option value="74">Eduskuntavaalit keskustan kannatus</option>
    <option value="75">Eduskuntavaalit oikeiston kannatus</option>
    <option value="73">Eduskuntavaalit vasemmiston kannatus</option>
    <option value="12">Ei perusasteen jälkeistä tutkintoa, 20+ -vuotiaat miehet</option>
    <option value="13">Ei perusasteen jälkeistä tutkintoa, 20+ -vuotiaat naiset</option>
    <option value="84">Eläkeläiset</option>
    <option value="8">Erikoissairaanhoidon nettokäyttökustannukset</option>
    <option value="117">Eurovaalit keskustan kannatus</option>
    <option value="118">Eurovaalit oikeiston kannatus</option>
    <option value="97">Eurovaalit vasemmiston kannatus</option>
    <option value="128">Hedelmällisyys</option>
    <option value="11">Henkilöautot</option>
    <option value="21">Informaatiosektorin työpaikat</option>
    <option value="65">Isä, lapset 0-17</option>
    <option value="30b">Jalostuksen työlliset</option>
    <option value="61">Kahden vanhemman perheet, lapset 0-17</option>
    <option value="22">Kaupan työpaikat</option>
    <option value="82">Käytettävissä oleva mediaanirahatulo</option>
    <option value="81">Kelan maksamat tuet</option>
    <option value="49">Keskituloisin 10 %</option>
    <option value="16">Korkea-asteen tutkinnon suorittaneet, 20+ -vuotiaat miehet</option>
    <option value="17">Korkea-asteen tutkinnon suorittaneet, 20+ -vuotiaat naiset</option>
    <option value="7">Kotimaiset kielet yhteensä</option>
    <option value="23">Koulutuksen työpaikat</option>
    <option value="83">Koulutustasomittain</option>
    <option value="77">Kunnallisvaalit keskustan kannatus</option>
    <option value="78">Kunnallisvaalit oikeiston kannatus</option>
    <option value="76">Kunnallisvaalit vasemmiston kannatus</option>
    <option value="107">Kunnallisveroprosentti</option>
    <option value="109">Kunnallisverot</option>
    <option value="19">Kunta ja valtio työllistäjänä</option>
    <option value="85">Kuntien välinen lähtömuutto</option>
    <option value="86">Kuntien välinen tulomuutto</option>
    <option value="114">Kuntouttava työtoiminta</option>
    <option value="10">Kuntoutuspalvelukustannukset</option>
    <option value="103">Kuollutta / 1000 asukasta</option>
    <option value="88">Lapsilisät</option>
    <option value="89">Lasten kotihoidontuet</option>
    <option value="87">Lastenhoidon tuet</option>
    <option value="3">Liikennerikokset 25-54</option>
    <option value="56">Liikkeen- ja ammatinharjoittajan tulo</option>
    <option value="105">Maahanmuuttaneet</option>
    <option value="106">Maastamuuttaneet</option>
    <option value="54">Maatalouden jaettava tulo</option>
    <option value="93">Maksetut tulonsiirrot, keskiarvo</option>
    <option value="50">Mediaanipalkka</option>
    <option value="55">Metsätalouden tulo</option>
    <option value="68">MYEL-työtulo</option>
    <option value="91">Nuorisotoiminnan avustukset</option>
    <option value="115">Omaehtoinen opiskelu</option>
    <option value="1">Omaisuusrikokset 25-54</option>
    <option value="44">Omaisuustulot, keskiarvo</option>
    <option value="30">Omassa seutukunnassa työssäkäyvät</option>
    <option value="94">Opiskelijat</option>
    <option value="53">Osingot, brutto </option>
    <option value="95">Ostovoima</option>
    <option value="90">Päivä- ja äitiyspäivärahat</option>
    <option value="41">Palkkatulot, ei perusasteen tutkintoa</option>
    <option value="42">Palkkatulot, keskiarvo</option>
    <option value="40">Palkkatulot, tutkinnon suorittaneet</option>
    <option value="113">Palveluissa yhteensä</option>
    <option value="30c">Palvelutoimialojen työlliset</option>
    <option value="59">Perheet, joissa alle 3-vuotiaita lapsia</option>
    <option value="9">Perusterveydenhuollon nettokäyttökustannukset</option>
    <option value="96">Pienituloinen asuntoväestö</option>
    <option value="48">Pienituloisin 10 %</option>
    <option value="98">Pienituloisten henkilöiden lukumäärä asuntoväestössä</option>
    <option value="24">Rakentamisen työpaikat</option>
    <option value="119">Raportoidut omaisuusrikokset</option>
    <option value="123">Raportoidut seksuaalirikokset</option>
    <option value="121">Raportoidut väkivaltarikokset</option>
    <option value="92">Saadut tulonsiirrot, keskiarvo</option>
    <option value="120">Selvitetyt omaisuusrikokset</option>
    <option value="125">Selvitetyt omaisuusrikokset 18-29 -vuotiaat</option>
    <option value="126">Selvitetyt omaisuusrikokset 30-49 -vuotiaat</option>
    <option value="127">Selvitetyt omaisuusrikokset 50-64 -vuotiaat</option>
    <option value="124">Selvitetyt seksuaalirikokset</option>
    <option value="122">Selvitetyt väkivaltarikokset</option>
    <option value="79">Sisäänpendelöinti</option>
    <option value="47">Suurituloisin 10 %</option>
    <option value="57">Syntyneet, äiti 20-29 -vuotias</option>
    <option value="58">Syntyneet, äiti 30-39 -vuotias</option>
    <option value="102">Syntyneitä / 1000 asukasta</option>
    <option value="131">Syntyvyys</option>
    <option value="25">Teollisuuden työpaikat</option>
    <option value="26">Terveys- ja sosiaalipalvelujen työpaikat</option>
    <option value="6">THL:n sairastavuusindeksi</option>
    <option value="99">Toimeentulotukea yksin asuvat miehet</option>
    <option value="100">Toimeentulotukea yksin asuvat naiset</option>
    <option value="130">Toimeentulotuki</option>
    <option value="14">Toisen asteen tutkinnon suorittaneet, 20+ -vuotiaat miehet</option>
    <option value="15">Toisen asteen tutkinnon suorittaneet, 20+ -vuotiaat naiset</option>
    <option value="45">Tuotannontekijätulot, keskiarvo</option>
    <option value="39">Työlliset, 18-24 -vuotiaat</option>
    <option value="38">Työlliset, 25-34 -vuotiaat</option>
    <option value="37">Työlliset, 35-44 -vuotiaat</option>
    <option value="36">Työlliset, 45-54 -vuotiaat</option>
    <option value="35">Työlliset, 55-59 -vuotiaat</option>
    <option value="34">Työlliset, 60-64 -vuotiaat</option>
    <option value="29">Työlliset, korkea-asteen koulutus</option>
    <option value="27">Työlliset, perusasteen koulutus</option>
    <option value="28">Työlliset, toisen asteen koulutus</option>
    <option value="101">Työttömyysetuudet</option>
    <option value="110">Ulkomaalaistaustaisia</option>
    <option value="112">Ulkomaan kansalaisia</option>
    <option value="111">Ulkomailla syntyneitä</option>
    <option value="80">Ulospendelöinti</option>
    <option value="72">Uudet henkilö- ja pakettiautokortit (B)</option>
    <option value="108">Valtionverot</option>
    <option value="46">Veronalaiset mediaanitulot</option>
    <option value="7a">Vieraskielisiä</option>
    <option value="4">Viranomaisten tehtävät</option>
    <option value="20">Voittoa tavoittelemattomien yhteisöjen työpaikat</option>
    <option value="104">Väestölisäys</option>
    <option value="2">Väkivaltarikokset</option>
    <option value="67">YEL-työtulo</option>
    <option value="60">Yhden vanhemman perheet, lapset 0-17</option>
    <option value="18">Yksityisen sektorin työpaikat</option>
    <option value="33">Yrittäjät, miehet</option>
    <option value="69">Yrittäjät, naiset</option>
    <option value="43">Yrittäjätulot, keskiarvo</option>
    <option value="116">Yrityskanta</option>
    <option value="64">Äiti, lapset 0-17</option>
    </select>
    </div>
    <section id="cssfun2">
        <label></label>
        <input type="range">
        <label></label>
    </section>
<div id="d3-kunta">
</div>
<h6>
Kuntakohtaiset tilastomuuttujat ovat JSON -tiedostomuotoon luotu tietokanta muuttujien v&auml;lisist&auml; korrelaatiokertoimista. Sen avulla voi havainnollistaa muutoksiin liittyvi&auml; heijastevaikutuksia.

L&auml;hdeaineisto on koottu p&auml;&auml;osin Kelan, Tilastokeskuksen, THL:n ja Verohallinnon tilastotietokannoista.

Korrelaatiot on laskettu vuosien 2014 ja 2018 v&auml;lisest&auml; muutoksesta, tai kyseist&auml; ajanjaksoa l&auml;himmilt&auml; vuosilta, kuten esimerkiksi kunnallis-, eduskunta- ja eurovaaleihin liittyv&auml; tieto. T&auml;ll&auml; hetkell&auml; vertailussa on runsaat sata muuttujaa.

L&auml;hdeaineistoille on laskettu my&ouml;s niiden tilastollista luotettavuutta kuvaavia indikaattoreita. L&auml;hdeaineisto julkaistaan myöhemmin Excel-taulukkona.

Aineisto on tarkoitettu ensisijaisesti vihjetietokannaksi, joka toivon mukaan auttaa hahmottamaan, ja arvioimaan eri muuttujien v&auml;lisi&auml; suhteita, ja riippuvuuksia visualisoinnin keinoin. Pelk&auml;n tietokannan perusteella ei kuitenkaan tule tehd&auml; kovin pitk&auml;lle menevi&auml; johtop&auml;&auml;t&ouml;ksi&auml;, vaan sen tarkoituksena on toimia pikemmin kannusteena varsinaiselle tutkimukselle.

Näin k&auml;yt&auml;t tietokantaa:

<ol>

<li>Rajaa hakusanalla, esimerkiksi vero, 0, naiset, ty&ouml;, jne...</li>

<li>Valitse ja hylk&auml;&auml; muuttujia, nimikett&auml; klikkaamalla</li>

<li>S&auml;&auml;d&auml; korrelaatiokertoimien minimiarvoja</li>

<li>Liikuttele alle ilmestyv&auml;&auml; kuviota</li>

<li>Kuviossa n&auml;kyv&auml;t my&ouml;s korrelaatiokertoimet</li>

</ol>

Tietokanta on julkaistu avoimena l&auml;hdekoodina <a href="https://github.com/tilastomuuttujat/kuntatilastomuuttujat">GitHub</a>-verkkopalvelussa. Avoimella l&auml;hdekoodilla tarkoitetaan ohjelmistoa, jota k&auml;ytt&auml;j&auml; voi vapaasti hy&ouml;dynt&auml;&auml;, muokata, sek&auml; jaella uudestaan.
</h6>
</div>
    <script>
var konsoli=[];
var minval = -0.2,
    maxval = 0.2;
var width  = 1200,
    height = 900;
var sitems=[];
var force = d3.layout.force()
    .charge(-3000)
    .gravity(.8)
    .size([width, height]);

var nodes = force.nodes(),
links = force.links();

var svgNodes, svgLinks, svgTexts, labels;
var svg = d3.select("#d3-kunta").append("svg")
    .attr("width", width)
    .attr("height", height);

function draw() {
d3.selectAll("#d3-kunta > *").remove();
svg = d3.select("#d3-kunta").append("svg")
    .attr("width", width)
    .attr("height", height);
    
force = d3.layout.force()
    .charge(-3000)
    .gravity(.8)
    .size([width, height]);
nodes = force.nodes();
links = force.links();

links = konsoli.filter(function(d){return d.value < minval || d.value > maxval;});
konsoli = [];
links.forEach(function (link) {
link.source = nodes[link.source] || (nodes[link.source] = {name: link.source, linkCount: link.value});
link.target = nodes[link.target] || (nodes[link.target] = {name: link.target, linkCount: link.value});
});

nodes = d3.values(nodes)
links.forEach(function (link) {
  link.linkWidth  = 3;
  link.headLength = 15;
  link.headWidth  = 5;
});

force
    .nodes(nodes)
    .links(links)
    .on("tick", tick)
    .start();

nodes.forEach(function(node) {node.r = 3 + 1.1 * node.weight })

svgLinks = svg.selectAll(".link").data(links)
  .enter().append("polygon")
    .attr("class", function (d) { 
    if (d.value>minval && d.value<maxval) {
    return "link licensing";
    } else {
    if (d.value<0) {
    return "link suit"
    }
    if (d.value>0) {
    return "link resolved"
    }}
    });
    
svgNodes = svg.selectAll(".node").data(nodes)
  .enter().append("circle")
    .attr("class", "node")
    .attr("r", function (d) {return d.r})
    .call(force.drag);

svgTexts = svg.selectAll("text").data(nodes)
  .enter().append("text")
    .attr("y", ".31em")
    .text(function(d) {return d.name});

edgepaths = svg.selectAll(".edgepath")
            .data(links)
            .enter()
            .append('path')
            .attr({
                'class': 'edgepath',
                'fill-opacity': 0,
                'stroke-opacity': 0,
                'id': function (d, i) {return 'edgepath' + i}
            })
            .style("pointer-events", "none");

edgelabels = svg.selectAll(".edgelabel")
            .data(links)
            .enter()
            .append('text')
            .style("pointer-events", "none")
            .attr({
                'class': 'edgelabel',
                'id': function (d, i) {return 'edgelabel' + i},
                'font-size': 10,
                'fill': '#aaa'
            });

edgelabels.append('textPath')
            .attr('xlink:href', function (d, i) {return '#edgepath' + i})
            .style("text-anchor", "middle")
            .style("pointer-events", "none")
            .attr("startOffset", "50%")
            .text(function (d) {return d.value.toLocaleString({minimumFractionDigits: 2,})});
}

function tick() {
  svgNodes.attr("transform", translate);
  svgTexts.attr("transform", translate);
  svgLinks.attr("points", calculatePolygon);
  
  
  edgepaths.attr('d', function (d) {
            return 'M ' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y;
        });

}

function translate (d) {
  return "translate(" + d.x + "," + d.y + ")";
}

function calculatePolygon(d) {
  var p2  = d.source,
      w   = diff(d.target, p2),
      wl  = length(w),
      v1  = scale(w, (wl - d.target.r) / wl),
      p1  = sum(p2, v1),
      v2  = scale(rotate90(w), d.linkWidth / length(w)),
      p3  = sum(p2, v2),
      v1l = length(v1),
      v3  = scale(v1, (v1l - d.headLength) / v1l),
      p4  = sum(p3, v3),
      v2l = length(v2),
      v4  = scale(v2, d.headWidth / v2l),
      p5  = sum(p4, v4);
  return pr(p1) +" "+ pr(p2) +" "+ pr(p3) +" "+ pr(p4) +" "+ pr(p5);
  
  function length(v) {return Math.sqrt(v.x * v.x + v.y * v.y)}
  function diff(v, w) {return {x: v.x - w.x, y: v.y - w.y}}
  function sum(v, w) {return {x: v.x + w.x, y: v.y + w.y}}
  function scale(v, f) {return {x: f * v.x, y: f * v.y}}
  function rotate90(v) {return {x: v.y, y: -v.x}}
  function pr(v) {return v.x +","+ v.y}
}

function valinnat(items) {
sitems=items;
	for ( x = 0; x < items.length; x++ ) {
	var fitems = "data/F"+items[x]+".json";
	$.ajax({dataType: "json", url: fitems, data: links, async: false, success: function(data) {
    for ( y = 0; y < data.links.length; y++ ) {
	konsoli.push({source: data.links[y].source, target: data.links[y].target, value: data.links[y].value});
	}}});
	}
	draw();
	}
	
var $inputs = $("input[type=range], span.slider"),
            change = function (event, value, isFirstHandle) {
                $(event.currentTarget).parent("div").next("label").text(value);
            };

    $inputs.eq(0).rsSliderLens({
            paddingStart: .075,
            paddingEnd: .075,
            value: [-20, 20],
            width: 750,
            step: 1,
            min: -100,
            max: 100,
            handle: {
                size: .15
            },
            range: {
                type: 'between'
            },
            ruler: {
                labels: {
                    values: [-100, -80, -60, -40, -20, 0, 20, 40, 60, 80, 100]
                }
            },
            onChange: function (event, value, isFirstHandle) {
                $("#cssfun2 > label").eq(isFirstHandle ? 0 : 1).text(value + "%");
                if (isFirstHandle) {
                minval = value/100;
                } else {
                maxval = value/100;
                }
                setTimeout(function () {valinnat(sitems)}, 2000);
            }
        });
</script>
</body>
</html>
