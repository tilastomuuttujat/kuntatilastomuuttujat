
<!DOCTYPE html>
<html lang="en">
<head>
<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<style>
.tree ul {
  display: none;
  margin: 2px auto;
  margin-left: 4px;
}

.tree ul li {
height:8px;
}

.has > label {
  color: #000;
}

.child > label {
font-size:11px;
  color: #000;
}

table {border-collapse: collapse;}
th,td {
border: 1px solid #ededed;
font-size:8px;
}

tr:hover,
tr:focus-within {
  background: #f2f3ff;
  outline: none;
}

div.inp {
visibility:hidden;
z-index:-1000;
}

.heatmap {
  font-size: 8px;
  font-family: monospace;
}

rect.bordered {
  stroke: #E6E6E6;
  stroke-width:2px;   
}

text.mono {
  font-size: 8px;
  font-family: monospace;
  fill: #000;
}

text.legendElement {
  font-size: 10px;
}

text.hover {
  font-weight: bold;
  fill: #66F;
  font-background: #000;
}

.heatmap_tooltip {
  text-align: center;
  font-family: monospace;
  font-size: 14pt;
  color: #000;
  position: relative;
  background: rgba(255, 255, 255, 0.8);
  border: 4px solid #66F;
  padding: 5px;
  border-radius: 8px ;
  width: 100px;
  z-index:10000;
  -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.8);
  -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.8);
  box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.8);
}

.heatmap_tooltip:after, .heatmap_tooltip:before {
  top: 100%;
  border: solid transparent;
  content: " ";
  height: 0;
  width: 0;
  position: absolute;
  pointer-events: none;
}

.heatmap_tooltip:after {
  border-color: rgba(236, 240, 241, 0);
  border-top-color: #FFFFF;
  border-width: 10px;
  left: 50%;
  margin-left: -10px;
}

.heatmap_tooltip:before {
  border-color: rgba(44, 62, 80, 0);
  border-top-color: #66F;
  border-width: 16px;
  left: 50%;
  margin-left: -16px;
}

#sidebar {
  position: fixed;
  width: 450px;
  height: 300%;
  background: rgb(255,255,255);
  right: -450px;
  transition: all 250ms linear;
}
#sidebar.active {
  right: 0px;
}
#sidebar ul li {
  color: rgba(230, 230, 230, 0.9);
  list-style: none;
  padding: 15px 10px;
  border-bottom: 1px solid rgba(100, 100, 100, 0.3);
}
#sidebar .toggle-btn {
  position: absolute;
  right: 470px;
  top: 20px;
}
#sidebar .toggle-btn span {
  display: block;
  width: 30px;
  height: 5px;
  background: #727e87;
  margin: 5px 0px;
}
#sidebar1 {
  position: fixed;
  width: 450px;
  height: 300%;
  background: rgb(255,255,255);
  left: -450px;
  transition: all 250ms linear;
}
#sidebar1.active {
  left: 0px;
}
#sidebar1 .toggle-btn {
  position: absolute;
  left: 470px;
  top: 20px;
}
#sidebar1 ul li {
  color: rgba(230, 230, 230, 0.9);
  list-style: none;
  padding: 15px 10px;
  border-bottom: 1px solid rgba(213,213,213,0.748);
}
#sidebar1 .toggle-btn span {
  display: block;
  width: 30px;
  height: 5px;
  background: #727e87;
  margin: 5px 0px;
}
</style>
</head>
<body>
<div id="sidebar">
  <div class="toggle-btn" onclick="toggleSidebar()">
    <span></span>
    <span></span>
    <span></span>
  </div>
  <div style="overflow-y: scroll; height:500px;" id="json"></div>
</div>
<div id="sidebar1">
  <div class="toggle-btn" onclick="toggleSidebar1()">
    <span></span>
    <span></span>
    <span></span>
  </div>
    <div style="overflow-y: scroll; height:500px;" id="json1"></div>
</div>

<div id="heatmap"></div>
	
<form class="file-process-framework">
<div class="inp"><textarea id="input_data"></textarea></div> 
<div id="variables_container"></div>
</form>
<script>
function toggleSidebar() {
document.getElementById("sidebar").classList.toggle('active');
}
function toggleSidebar1() {
document.getElementById("sidebar1").classList.toggle('active');
}

var raja = "D";
var alin = 3;
var ala = 6;
var yla = 100;
var ylin = 1200;

var minval=parent.minval;
var maxval=parent.maxval;
var fitems=parent.fitems;
var _data = [];
var konsoli=[];

var colorbrewer = {RdGy: {
3: ["#ef8a62","#ffffff","#999999"],
4: ["#ca0020","#f4a582","#bababa","#404040"],
5: ["#ca0020","#f4a582","#ffffff","#bababa","#404040"],
6: ["#b2182b","#ef8a62","#fddbc7","#e0e0e0","#999999","#4d4d4d"],
7: ["#b2182b","#ef8a62","#fddbc7","#ffffff","#e0e0e0","#999999","#4d4d4d"],
8: ["#b2182b","#d6604d","#f4a582","#fddbc7","#e0e0e0","#bababa","#878787","#4d4d4d"],
9: ["#b2182b","#d6604d","#f4a582","#fddbc7","#ffffff","#e0e0e0","#bababa","#878787","#4d4d4d"],
10: ["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#e0e0e0","#bababa","#878787","#4d4d4d","#1a1a1a"],
11: ["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#ffffff","#e0e0e0","#bababa","#878787","#4d4d4d","#1a1a1a"]},BrBG: {
3: ["#d8b365","#f5f5f5","#5ab4ac"],
4: ["#a6611a","#dfc27d","#80cdc1","#018571"],
5: ["#a6611a","#dfc27d","#f5f5f5","#80cdc1","#018571"],
6: ["#8c510a","#d8b365","#f6e8c3","#c7eae5","#5ab4ac","#01665e"],
7: ["#8c510a","#d8b365","#f6e8c3","#f5f5f5","#c7eae5","#5ab4ac","#01665e"],
8: ["#8c510a","#bf812d","#dfc27d","#f6e8c3","#c7eae5","#80cdc1","#35978f","#01665e"],
9: ["#8c510a","#bf812d","#dfc27d","#f6e8c3","#f5f5f5","#c7eae5","#80cdc1","#35978f","#01665e"],
10: ["#543005","#8c510a","#bf812d","#dfc27d","#f6e8c3","#c7eae5","#80cdc1","#35978f","#01665e","#003c30"],
11: ["#543005","#8c510a","#bf812d","#dfc27d","#f6e8c3","#f5f5f5","#c7eae5","#80cdc1","#35978f","#01665e","#003c30"]},Spectral: {
3: ["#ff0000","#ffffff","#008900"],
4: ["#d7191c","#fdae61","#abdda4","#2b83ba"],
5: ["#d7191c","#fdae61","#ffffbf","#abdda4","#2b83ba"],
6: ["#d53e4f","#fc8d59","#fee08b","#e6f598","#99d594","#3288bd"],
7: ["#d53e4f","#fc8d59","#fee08b","#ffffbf","#e6f598","#99d594","#3288bd"],
8: ["#d53e4f","#f46d43","#fdae61","#fee08b","#e6f598","#abdda4","#66c2a5","#3288bd"],
9: ["#d53e4f","#f46d43","#fdae61","#fee08b","#ffffbf","#e6f598","#abdda4","#66c2a5","#3288bd"],
10: ["#9e0142","#d53e4f","#f46d43","#fdae61","#fee08b","#e6f598","#abdda4","#66c2a5","#3288bd","#5e4fa2"],
11: ["#9e0142","#c50142","#e90142","#ff0142","#ffffff","#ffffff","#ffffff","#13e726","#13ca26","#13a626","#137a26"]}};


var diagram = {
	render: function() {
		diagram.get_data1();
		diagram.get_data2();
	},
    get_data1: function() {
var merkki = "";
var ryhma = "alku";
var alaryhma = "";
var rivit = 0;
var id = '1kus7FnXUf0dl9mnTe3y5vEMOqxHAoVAwsRnooetUX3Y';
var gid = '270476198';
var url = 'https://docs.google.com/spreadsheets/d/'+id+'/gviz/tq?tqx=out:json&tq&gid='+gid;
fetch(url)
  .then(response => response.text())
  .then(data => document.getElementById("json").innerHTML=myItems(data.slice(47, -2))  
  );
  
function myItems(jsonString){
  var json = JSON.parse(jsonString);
  json.table.cols.forEach(colonne => table += '<label>' + colonne.label + '</label>')
  var table = '<ul class="tree">'
  json.table.rows.forEach(ligne => {
  var check = 0;
    ligne.c.forEach(cellule => {
        try{var valeur0 = cellule.f ? cellule.f : cellule.v}
        catch(e){var valeur0 = ''}
        if (check == 0) {
        alaryhma=valeur0;
        if (ryhma!= alaryhma) {
        
        if (ryhma!= "alku") {table += '</ul></li>'}
        table += '<li class="has"><input class="domain" type="checkbox" name="domain" value="' + valeur0 + '" onClick="diagram.muuttujat()"></input>'
        table += '<label>' + valeur0 + '</label><ul class="parent">'
        
        }
        ryhma=alaryhma;
        
        } 
        
        if (check == 1) {
        merkki = valeur0;
        }
        
        if (check == 2) {
         table += '<li class="child"><input class="subdomain" type="checkbox" name="subdomain" value="' + merkki + '" onClick="diagram.muuttuja()"></input>'
         table += '<label>' + valeur0 + '</label></li>'        
        }

        check += 1;
      })
    }
  )
  table += '</ul>'
  return table
}

$(document).on('click', '.tree label', function(e) {
  $(this).next('ul').fadeToggle();
  e.stopPropagation();
});

$(document).on('change', '.tree input[type=checkbox]', function(e) {
  $(this).siblings('ul').find("input[type='checkbox']").prop('checked', this.checked);
  $(this).parentsUntil('.tree').children("input[type='checkbox']").prop('checked', this.checked);
  e.stopPropagation();
});
	},
	
	muuttujat: function () {
            setTimeout(() => {
            var checkboxes = document.querySelectorAll('input[name="domain"]:checked');
            var values = [];
            checkboxes.forEach((checkbox) => {
                values.push(checkbox.value);
            });
            diagram.muuttuja();
            }, 200);
    },
	
	muuttuja: function () {
            var checkboxes = document.querySelectorAll('input[name="subdomain"]:checked');
            var values = [];
            checkboxes.forEach((checkbox) => {
                values.push(checkbox.value);
            });
            var siirto = values;
            values = [];
            diagram.get_data3(0,siirto);
    },

	muuttuja0: function () {
            var checkboxes = document.querySelectorAll('input[name="subdomain1"]:checked');
            var values1 = [];
            checkboxes.forEach((checkbox) => {
                values1.push(checkbox.value);
            });
            var piirto = values1;
            values1 = [];
            diagram.get_data3(1,piirto);
    },

    get_data2: function() {
var viesti1 = [];
var rivit1 = 0;
var haku1 = [];
var taso1 = [];
var alin = [];
var ala = [];
var yla = [];
var ylin = [];
var id = '1kus7FnXUf0dl9mnTe3y5vEMOqxHAoVAwsRnooetUX3Y';
var gid = '1445091643';
var url = 'https://docs.google.com/spreadsheets/d/'+id+'/gviz/tq?tqx=out:json&tq&gid='+gid;
fetch(url)
  .then(response => response.text())
  .then(data => document.getElementById("json1").innerHTML=myItems(data.slice(47, -2))  
  );
function myItems(jsonString){
  var json = JSON.parse(jsonString);
  var table = '<table><tr>'
  table += '<th>Muuttuja</th><th>Alin</th><th>Ala</th><th>Ylä</th><th>Ylin</th><th>Valitse</th>'
  table += '</tr>'
  json.table.rows.forEach(ligne => {
  var check = 0;
    table += '<tr>'
    ligne.c.forEach(cellule => {
        try{var valeur = cellule.f ? cellule.f : cellule.v}
        catch(e){var valeur = ''}
        
        if (check == 1)
        alin[rivit1-1] = valeur;
        
        if (check == 3)
        ala[rivit1-1] = valeur;

        if (check == 5)
        yla[rivit1-1] = valeur;
        
        if (check == 7)
        ylin[rivit1-1] = valeur;
        
        if (check == 9)
        haku1[rivit1-1] = valeur;
         
        if (check > 8) {
        viesti1.push(haku1[rivit1-1], alin[rivit1-1], ala[rivit1-1], yla[rivit1-1], ylin[rivit1-1]);

        table += '<td><input name="subdomain1" type="radio" value="' + viesti1 + '" onClick="diagram.muuttuja0()"></input></td>'

        rivit1 +=1;
        viesti1 = [];
        }

        if(check % 2 == 0) {
        table += '<td>' + valeur + '</td>'
        }
        check += 1;
      }
    )
    table += '</tr>'
    }
  )
  taso1=table;
  table += '</table>'
  return table
}
	},
	
	get_data3: function(laji,valu){
var lista = valu.toString();
var nimike = [];
var sarakkeita = 0;
var riveja = 0;
var risa = 0;
var sari = 0;

if (laji == 0) {
	haku = valu.toString();
	lista = valu.toString();
	} else {
	raja = valu.toString();
	var myArray = raja.split(",");
	raja = myArray[0];
	ala = myArray[1];
	alin = myArray[2];
	yla = myArray[3];
	ylin = myArray[4];
}

function init() {
var url = 'https://docs.google.com/spreadsheets/d/1kus7FnXUf0dl9mnTe3y5vEMOqxHAoVAwsRnooetUX3Y/edit#gid=1354196778';
  var query = new google.visualization.Query(url);
  
    var haku1 = "SELECT " + haku + " WHERE " + raja + "<" + alin;
    var haku2 = "SELECT " + haku + " WHERE " + raja + ">=" + alin + " AND " + raja + "<" + ala;
    var haku3 = "SELECT " + haku + " WHERE " + raja + ">=" + ala + " AND " + raja + "<" + yla;
    var haku4 = "SELECT " + haku + " WHERE " + raja + ">=" + ylin;
    var haku5 = "SELECT " + haku + " WHERE " + raja + ">=" + alin + " AND " + raja + "<" + yla;
    var haku6 = "SELECT " + haku ;

  str = haku5;
  str = str.replace(/"+/g, "");
  query.setQuery(str);
  query.send(processSheetsData);
}

function changelimit(selection) {
limit=selection;
google.charts.load('current');
google.charts.setOnLoadCallback(init);
}

function processSheetsData(response) {
var array = [];
var activities = [];
var data = response.getDataTable();
  
var tiedot=[];
tiedot.push(haku);
var tieto = "";
  
var columns = data.getNumberOfColumns();
var rows = data.getNumberOfRows();

riveja = columns;
risa = columns;

if(risa % 2 == 0) {
risa=risa/2;
} else {
risa=(risa+1)/2;
}

for (var r = 0; r < rows; r++) {
    var row = [];
    for (var c = 0; c < columns; c++) {
      row.push(data.getFormattedValue(r, c));
      activities[r,c] = data.getFormattedValue(r, c);
    }
    tieto = row.join();
    tiedot.push(tieto); 
}

diagram.get_data31(tiedot,risa,riveja,lista);
  }
google.charts.load('current');
google.charts.setOnLoadCallback(init);
	},
	
	get_data31: function(tiedot,_risa,_riveja,lista){
var listaus = [];	
var tietoja= tiedot;	
var rotsi = [];	
var rivinumero = 0;
var sarakenumero = 0;
var nimike = [];
var sarakkeita = 0;

var riveja = _riveja;
var risa = _risa;
var sari = riveja-risa;
var _combine_input = function () {
    _data = {};  
    _calc_pearson_correlation();
};

//***** start of _calc_pearson_correlation
  var _calc_pearson_correlation = function () {
  var _attr_list = [];
      _attr_list_count = 0;
  var _csv_lines = tietoja;

  var _pair_number;

  for (var _i = 0; _i < _csv_lines.length; _i++) {
    let _line = _csv_lines[_i]
    if (_line.indexOf('\t') > -1) {
      _line = _line.split('\t')
    } else {
      _line = _line.split(',')
    }
    if (_pair_number === undefined) {
      _pair_number = _line.length;
    } else if (_pair_number !== _line.length) {
      return "";
    }

    for (var _j = 0; _j < _line.length; _j++) {
      var _value = _line[_j];

      if (_i === 0) {
        _data[_value] = [];
        _attr_list[_j] = _value;
        _attr_list_count++;
      } else {
        if (isNaN(_value)) {
          continue;
        }
        _value = eval(_value);
        _data[(_attr_list[_j])].push(_value); 
      }
    }
  }
listaus = _attr_list;
return _draw_result_table();
};
//*** end of _calc_pearson_correlation

//*** start of _draw_result_table
var _draw_result_table = function () {
var _attr_list = listaus;
var tieto = [];
var oikea = [];
var items = [];

sari=riveja-risa;
var initial = 0;

Array.matrix = function(risa, sari, initial) {
var arr = [];
    for (var i = 0; i < risa; ++i) {
        var columns = [];
        for (var j = 0; j < sari; ++j) {
            columns[j] = initial;
        }
        arr[i] = columns;
    }
    return arr;
}

var names = Array.matrix(500);


    var _result_data = {};
    for (var _i = 0; _i < _attr_list.length; _i++) {
         var _x_attr = _attr_list[_i];
    
sarakenumero += 1; 
rivinumero = -1;
nimike[_i]=_x_attr;
tieto.push(_x_attr,oikea);
oikea = [];
    
    var _ary1 = _data[_x_attr];
    for (var _j = 0; _i !== _attr_list.length - 1 && _j < _i; _j++) {
         var _y_attr = _attr_list[_j];

      if (typeof (_result_data[_x_attr]) === "undefined") {
        _result_data[_x_attr] = {};
      }

      if (_j !== _i) {
        _result_data[_x_attr][_y_attr] = null;
      }
    }
    
    for (var _j = _i + 1; _j < _attr_list.length; _j++) {
      var _y_attr = _attr_list[_j];
      rivinumero += 1; 

      if (typeof (_result_data[_x_attr]) === "undefined") {
        _result_data[_x_attr] = {};
      }
      var _ary2 = _data[_y_attr];
      _result_data[_x_attr][_y_attr] = _get_pearson_correlation(_ary1, _ary2);

const myJSON = _result_data[_x_attr][_y_attr];
names[sarakenumero][rivinumero]=myJSON.r.toFixed(3);
oikea.push(myJSON.r.toFixed(3));
items[_i,_j]=_result_data[_x_attr][_y_attr];
    }
  }
  
var heat1 = [];
var heat10 = [];
var rotsi = [];
var sotsi = [];
var merkki = "R";

for (var _r = 0; _r < riveja-risa; _r++) { 
rotsi.push([nimike[_r]]);
}

for (var _r = riveja-risa; _r < riveja; _r++) { 
sotsi.push([merkki,nimike[_r]]);
}

for (var _r = 1; _r <= risa; _r++) {

for (var _s = 0; _s < sari; _s++) { 
heat1.push(names[_r][_s]);
}
heat10.push(heat1);
heat1=[];
}
  
tiedot=tieto;
tsekki = 1;

diagram.get_data4(rotsi,sotsi,heat10);    
};
//*** end of _draw_result_table

//*** start of _get_pearson_correlation
var _get_pearson_correlation = function (_ary1, _ary2) {
  var _r = pearsonCorrelation(_ary1, _ary2);
  var _n = _ary1.length;
  var _t = _r * Math.sqrt((_n - 2) / (1 - (_r * _r)));
      _t = Math.abs(_t);
  var _p = ((tprob((_n - 2), _t)) * 2);
  if (_p === 2) {
      _p = 0;
  }
  
  if (isNaN(_p)) {
    console.log({
      'n-2': _n - 2,
      't': _t
    });
    console.log(['tprob', tprob((_n - 2), _t)]);
    throw "xx：NaN (r: " + _r + ";t: " + _t + "; _n: " + _n + " )";
  }

  return {
    r: _r
    //p: _p,
    //n: _n
  };
};
//*** end of _get_pearson_correlation

//*** start of pearsonCorrelation
var pearsonCorrelation = function (_ary1, _ary2) {
  var _avg1 = _calc_avg(_ary1);
  var _avg2 = _calc_avg(_ary2);
  var _a = 0;
  var _b1 = 0;
  var _b2 = 0;
  for (var _i = 0; _i < _ary1.length; _i++) {
    var _x = (_ary1[_i] - _avg1);
    var _y = (_ary2[_i] - _avg2);
    _a += _x * _y;
    _b1 += _x * _x;
    _b2 += _y * _y;
  }

  if (_b1 * _b2 === 0) {
    return 0;
  }
  return _a / (Math.sqrt(_b1) * Math.sqrt(_b2));
};
//*** end of pearsonCorrelation

var _calc_avg = function (_ary) {
  if (_ary.length === 0) {
    return;
  }
  var _sum = 0;
  for (var _i = 0; _i < _ary.length; _i++) {
    _sum += _ary[_i];
  }
  return (_sum / _ary.length);
};

var _calc_stdev = function (_ary) {
  if (_ary.length === 0) {
    return;
  }
  var _avg = _calc_avg(_ary);
  var _var = 0;

  for (var _i = 0; _i < _ary.length; _i++) {
    var _a = (_ary[_i] - _avg);
    _var += _a * _a;
  }
  return Math.sqrt(_var / (_ary.length - 1));
};

function tprob ($n, $x) {
    if (($n <= 0) || ((Math.abs($n) - Math.abs(integer($n))) !==0)) {
        throw("Invalid n: $n\n");
    }
    return _subtprob($n-0, $x-0);
}

function integer ($i) {
        if ($i > 0)
                return Math.floor($i);
        else
                return Math.ceil($i);
}

function _subtprob ($n, $x) {
	var $a;
        var $b;
	var $w = Math.atan2($x / Math.sqrt($n), 1);
	var $z = Math.pow(Math.cos($w), 2);
	var $y = 1;

	for (var $i = $n-2; $i >= 2; $i -= 2) {
		$y = 1 + ($i-1) / $i * $z * $y;
	} 

	if ($n % 2 === 0) {
		$a = Math.sin($w)/2;
		$b = .5;
	} else {
		$a = ($n === 1) ? 0 : Math.sin($w)*Math.cos($w)/Math.PI;
		$b= .5 + $w/Math.PI;
	}
	return max(0, 1 - $b - $a * $y);
}

function max () {
	var $max = arguments[0];
	for (var $i = 0; $i < arguments.length; $i++) {
                if ($max < arguments[$i])
                        $max = arguments[$i];
	}	
	return $max;
}

//*** start of function
var _panel = _combine_input();
//*** end of function
	},
	
	get_data4: function(rotsi,sotsi,risa){
	console.log(rotsi, rotsi.length);
var row_number = rotsi.length;
var col_number = sotsi.length;
var minval=parent.minval;
var maxval=parent.maxval;
var fitems=parent.fitems;
var _data = [];
var konsoli=[];

var classesNumber = 11,
    cellSize = 12;
//heatmap_display("#heatmap", "RdGy");
heatmap_display("#heatmap", "Spectral");
//heatmap_display("#heatmap", "BrBG");

function heatmap_display(heatmapId, paletteName) {
d3.selectAll("#heatmap > *").remove();

  var tooltip = d3.select(heatmapId)
    .append("div")
    .style("opacity", 0)
    .attr("class", "tooltip")
    .style("background-color", "white")
    .style("border", "solid")
    .style("border-width", "2px")
    .style("border-radius", "5px")
    .style("padding", "5px");
/*
  var mouseover = function(event,d) {
    tooltip.style("opacity", 1)
  }
  var mousemove = function(event,d) {
    tooltip
      .html("The exact value of<br>this cell is: " + d.value)
      .style("left", (event.x)/2 + "px")
      .style("top", (event.y)/2 + "px")
  }
  var mouseleave = function(d) {
    tooltip.style("opacity", 0)
  }
*/
    function zoom() {
    	svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
    }

    var zoomListener = d3.behavior.zoom().scaleExtent([0.1, 3]).on("zoom", zoom);
    var viewerWidth = $(document).width();
    var viewerHeight = $(document).height();
    var viewerPosTop = 200;
    var viewerPosLeft = 100;
    var legendElementWidth = cellSize * 2;
    var colors = colorbrewer[paletteName][classesNumber];
    //console.log(colors);
    var svg;

    var colorScale = d3.scale.quantize()
        .domain([-1.0, 1.0])
        .range(colors);
        

svg = d3.select(heatmapId).append("svg")
        .attr("width", viewerWidth)
        .attr("height", viewerHeight)
	    .call(zoomListener)
        .append("g")
        .attr("transform", "translate(" + viewerPosLeft + "," + viewerPosTop + ")");

svg.append('defs')
        .append('pattern')
        .attr('id', 'diagonalHatch')
        .attr('patternUnits', 'userSpaceOnUse')
        .attr('width', 4)
        .attr('height', 4)
        .append('path')
        .attr('d', 'M-1,1 l2,-2 M0,4 l4,-4 M3,5 l2,-2')
        .attr('stroke', '#000000')
        .attr('stroke-width', 1);

        var rowSortOrder = false;
        var colSortOrder = false;
        
        var rowLabels = svg.append("g")
            .attr("class", "rowLabels")
            .selectAll(".rowLabel")
            .data(rotsi) //rivi-rotsi
            .enter().append("text")
            .text(function(d) {
                return d.count > 1 ? d.join("/") : d;
            })
            .attr("x", 0)
            .attr("y", function(d, i) {
                return (i * cellSize);
            })
            .style("text-anchor", "end")
            .attr("transform", function(d, i) {
                return "translate(-3," + cellSize / 1.5 + ")";
            })
            .attr("class", "rowLabel mono")
            .attr("id", function(d, i) {
                return "rowLabel_" + i;
            })
            .on('mouseover', function(d, i) {
                d3.select('#rowLabel_' + i).classed("hover", true);
            })
            .on('mouseout', function(d, i) {
                d3.select('#rowLabel_' + i).classed("hover", false);
            })
            .on("click", function(d, i) {
                rowSortOrder = !rowSortOrder;
                sortByValues("r", i, rowSortOrder);
                d3.select("#order").property("selectedIndex", 0);
            });

        var colLabels = svg.append("g")
            .attr("class", "colLabels")
            .selectAll(".colLabel")
            .data(sotsi) //desult-sotsi
            .enter().append("text")
            .text(function(d) {
                d.shift();
                return d.count > 1 ? d.reverse().join("/") : d.reverse();
            })
            .attr("x", 0)
            .attr("y", function(d, i) {
                return (i * cellSize);
            })
            .style("text-anchor", "left")
            .attr("transform", function(d, i) {
                return "translate(" + cellSize / 2 + ", -3) rotate(-90) rotate(45, 0, " + (i * cellSize) + ")";
            })
            .attr("class", "colLabel mono")
            .attr("id", function(d, i) {
                return "colLabel_" + i;
            })
            .on('mouseover', function(d, i) {
                d3.select('#colLabel_' + i).classed("hover", true);
            })
            .on('mouseout', function(d, i) {
                d3.select('#colLabel_' + i).classed("hover", false);
            })
            .on("click", function(d, i) {
                colSortOrder = !colSortOrder;
                sortByValues("c", i, colSortOrder);
                d3.select("#order").property("selectedIndex", 0);
            });

        var row = svg.selectAll(".row")
            .data(risa) //data-risa
            .enter().append("g")
            .attr("id", function(d) {
                return d.idx;
            })
            .attr("class", "row");

        var j = 0;
        var heatMap = row.selectAll(".cell")
            .data(function(d) {
                j++;
                return d;
            })
            .enter().append("svg:rect")
            .attr("x", function(d, i) {
                return i * cellSize;
            })
            .attr("y", function(d, i, j) {
                return j * cellSize;
            })
            .attr("rx", 4)
            .attr("ry", 4)
            .attr("class", function(d, i, j) {
                return "cell bordered cr" + j + " cc" + i;
            })
            .attr("row", function(d, i, j) {
                return j;
            })
            .attr("col", function(d, i, j) {
                return i;
            })
            .attr("width", cellSize)
            .attr("height", cellSize)
            .style("fill", function(d) {
                if (d != null) return colorScale(d);
                else return "url(#diagonalHatch)";
            })
            .on('mouseover', function(d, i, j) {
            console.log(Number(d).toFixed(3));
                d3.select('#colLabel_' + i).classed("hover", true);
                d3.select('#rowLabel_' + j).classed("hover", true);
                if (d != null) {
                    tooltip.html('<div class="heatmap_tooltip">' + Number(d).toFixed(3) + '</div>');
                    tooltip.style("visibility", "visible");
                } else
                    tooltip.style("visibility", "hidden");
            })
            .on('mouseout', function(d, i, j) {
                d3.select('#colLabel_' + i).classed("hover", false);
                d3.select('#rowLabel_' + j).classed("hover", false);
                tooltip.style("visibility", "hidden");
            })
            .on("mousemove", function(d, i) {
                tooltip.style("top", (d3.event.pageY - 55) + "px").style("left", (d3.event.pageX - 60) + "px");
            })
            .on('click', function(d) {
            });

        var legend = svg.append("g")
            .attr("class", "legend")
            .attr("transform", "translate(0,-300)")
            .selectAll(".legendElement")
            .data([-1.0, -0.8, -0.6, -0.4, -0.2, 0.0, 0.2, 0.4, 0.6, 0.8, 1.0])
            .enter().append("g")
            .attr("class", "legendElement");

        legend.append("svg:rect")
            .attr("x", function(d, i) {
                return legendElementWidth * i;
            })
            .attr("y", viewerPosTop)
            .attr("class", "cellLegend bordered")
            .attr("width", legendElementWidth)
            .attr("height", cellSize / 2)
            .style("fill", function(d, i) {
                return colors[i];
            });

        legend.append("text")
            .attr("class", "mono legendElement")
            .text(function(d) {
                return Math.round(d * 100) / 100;
            })
            .attr("x", function(d, i) {
                return legendElementWidth * i;
            })
            .attr("y", viewerPosTop + cellSize);

        function sortByValues(rORc, i, sortOrder) {
            var t = svg.transition().duration(1000);
            var values = [];
            var sorted;
            d3.selectAll(".c" + rORc + i)
                .filter(function(d) {
                    if (d != null) values.push(d);
                    else values.push(-999); 
                });

            if (rORc == "r") { 
                sorted = d3.range(col_number).sort(function(a, b) {
                    if (sortOrder) {
                        return values[b] - values[a];
                    } else {
                        return values[a] - values[b];
                    }
                });
                t.selectAll(".cell")
                    .attr("x", function(d) {
                        var col = parseInt(d3.select(this).attr("col"));
                        return sorted.indexOf(col) * cellSize;
                    });
                t.selectAll(".colLabel")
                    .attr("y", function(d, i) {
                        return sorted.indexOf(i) * cellSize;
                    })
                    .attr("transform", function(d, i) {
                        return "translate(" + cellSize / 2 + ", -3) rotate(-90) rotate(45, 0, " + (sorted.indexOf(i) * cellSize) + ")";
                    });
            } else { 
                sorted = d3.range(row_number).sort(function(a, b) {
                    if (sortOrder) {
                        return values[b] - values[a];
                    } else {
                        return values[a] - values[b];
                    }
                });
                t.selectAll(".cell")
                    .attr("y", function(d) {
                        var row = parseInt(d3.select(this).attr("row"));
                        return sorted.indexOf(row) * cellSize;
                    });
                t.selectAll(".rowLabel")
                    .attr("y", function(d, i) {
                        return sorted.indexOf(i) * cellSize;
                    })
                    .attr("transform", function(d, i) {
                        return "translate(-3," + cellSize / 1.5 + ")";
                    });
            }
        }

        d3.select("#order").on("change", function() {
	    var newOrder = d3.select("#order").property("value");	
            changeOrder(newOrder, heatmapId);
        });

        d3.select("#palette")
            .on("keyup", function() {
		var newPalette = d3.select("#palette").property("value");
		if (newPalette != null)						
                	changePalette(newPalette, heatmapId);
            })
            .on("change", function() {
		var newPalette = d3.select("#palette").property("value");
                changePalette(newPalette, heatmapId);
            });
}

function changeOrder(newOrder, heatmapId) {
    var svg = d3.select(heatmapId);
    var t = svg.transition().duration(1000);
    if (newOrder == "sortinit_col") { 
        t.selectAll(".cell")
            .attr("x", function(d) {
                var col = parseInt(d3.select(this).attr("col"));
                return col * cellSize;
            });
        t.selectAll(".colLabel")
            .attr("y", function(d, i) {
                return i * cellSize;
            })
            .attr("transform", function(d, i) {
                return "translate(" + cellSize / 2 + ", -3) rotate(-90) rotate(45, 0, " + (i * cellSize) + ")";
            });
    } else if (newOrder == "sortinit_row") { 
        t.selectAll(".cell")
            .attr("y", function(d) {
                var row = parseInt(d3.select(this).attr("row"));
                return row * cellSize;
            });
        t.selectAll(".rowLabel")
            .attr("y", function(d, i) {
                return i * cellSize;
            })
            .attr("transform", function(d, i) {
                return "translate(-3," + cellSize / 1.5 + ")";
            });
    } else if (newOrder == "sortinit_col_row") { 
        t.selectAll(".cell")
            .attr("x", function(d) {
                var col = parseInt(d3.select(this).attr("col"));
                return col * cellSize;
            })
            .attr("y", function(d) {
                var row = parseInt(d3.select(this).attr("row"));
                return row * cellSize;
            });
        t.selectAll(".colLabel")
            .attr("y", function(d, i) {
                return i * cellSize;
            })
            .attr("transform", function(d, i) {
                return "translate(" + cellSize / 2 + ", -3) rotate(-90) rotate(45, 0, " + (i * cellSize) + ")";
            });
        t.selectAll(".rowLabel")
            .attr("y", function(d, i) {
                return i * cellSize;
            })
            .attr("transform", function(d, i) {
                return "translate(-3," + cellSize / 1.5 + ")";
            });
    }
}

function changePalette(paletteName, heatmapId) {
    var colors = colorbrewer[paletteName][classesNumber];
    var colorScale = d3.scale.quantize()
        .domain([-1.0, 1.0])
        .range(colors);
    var svg = d3.select(heatmapId);
    var t = svg.transition().duration(500);
    t.selectAll(".cell")
        .style("fill", function(d) {
                if (d != null) return colorScale(d);
                else return "url(#diagonalHatch)";
        })
    t.selectAll(".cellLegend")
        .style("fill", function(d, i) {
            return colors[i];
        });
}
	
	},
	
};

function valinnat(items, mini, maxi) {
konsoli=[];
var links =[];
var minval=mini;
var maxval=maxi;
var sitems=items;
	for ( x = 0; x < items.length; x++ ) {
	var fitems = "data/F"+items[x]+".json";
	$.ajax({dataType: "json", url: fitems, data: links, async: false, success: function(data) {
    for ( y = 0; y < data.links.length; y++ ) {
	konsoli.push({source: data.links[y].source, target: data.links[y].target, value: data.links[y].value});
	}}});
	}
	links = konsoli.filter(function(d){return d.value < minval || d.value > maxval;});
	_data = links;
	diagram.render();
	}
	
//valinnat(fitems,minval,maxval);
valinnat(["11"],-0.3,0.3);
</script>
</body>
</html>
