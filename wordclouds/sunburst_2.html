<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <title>D3 v5 Zoomable Sunburst</title>

  <style>
    * {
      font-family: 'open_sanssemibold', Helvetica, Verdana, sans-serif;
    }

    .flex {
      display: flex;
      flex-direction: column;
    }

    .flex-center {
      align-items: center;
      justify-content: center;
      margin: 0 auto;
    }

    .modal {
      background: #fff;
      border-radius: 12px;
      opacity: 0;
      padding: 20px;
      width: 400px;
      display: hidden;
      box-shadow: 1px 0px 2px 0px #b9b9b9;
      position: absolute;


      transition: all 0.8s ease;
    }

    .modal__close {
      background: #fff;
      background: #fff;
      color: #000;
      /* display: block; */
      font-weight: bold;
      /* height: 3rem; */
      line-height: 3rem;
      text-align: center;
      text-decoration: none;
      width: 3rem;
      border-radius: 100%;
      /* box-shadow: 0 0 4px rgba(0, 0, 0, 0.5); */
      position: absolute;
      top: 0;
      right: 0;
    }

    .modal:target {
      opacity: 1;
      display: block;
    }

    table {
      background-color: #1ba7cc;
      border: 2px solid #1ba7cc;
      border-collapse: collapse;
      margin-bottom: 100px;
    }


    th,
    td {
      border: 1px solid white;
      border-spacing: 0px;
      padding: 5px;
      font-size: 18px;
      line-height: 28px;
    }
  </style>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@observablehq/stdlib"></script>
</head>

<body>





  <div class="flex flex-center">


    <div class="modal" id="modal">
      <div>
        <h3 class="heading"></h3>
        <p><span>Score: </span><span class="score"></span></p>
        <p><span>Recommendation: </span><span class="recommendation"></span></p>
        <p class="text"></p>
      </div>
      <div class="modal-footer">
        <a href="" class="link" target="_blank"></a>
      </div>
      <a class="modal__close" href="#">x</a>
    </div>

    <svg id="partitionSVG" style="width: 50%; height: 50%;" viewBox="0 0 932 932"></svg>
  </div>


  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

  <script>
    const format = d3.format(",d");
    const width = 932;
    const radius = width / 6;

    const arc = d3.arc()
      .startAngle(d => d.x0)
      .endAngle(d => d.x1)
      .padAngle(d => Math.min((d.x1 - d.x0) / 2, 0.005))
      .padRadius(radius)
      .innerRadius(d => d.y0 * radius)
      .outerRadius(d => Math.max(d.y0 * radius, d.y1 * radius - 1));

    const partition = data => {
      const root = d3.hierarchy(data)
        .sum(d => d.size)
        .sort((a, b) => b.value - a.value);
      return d3.partition()
        .size([2 * Math.PI, root.height + 1])
        (root);
    }

    const { require } = new observablehq.Library;
    var data = require('')


    // jQuery.getJSON('http://gsx2json.com/api?id=19ce7vXm_7WsysxROv96nEKongKOWQHY9h5Zncx0nhNs&sheet=2', function (data) {

    //   // console.log('loggin feed data ' + JSON.stringify(data.rows))



    //   // "organisation": "Climate Change Commission Letter to Rosanna Cunningham",
    //   //   "publication": "Six key principles to build back better",
    //   //     "recommendation": "Tackle the wider ‘resilience deficit’ on climate change.",
    //   //       "description": "This crisis has emphasised theimportance of evidence-led preparations for the key risks facing the country. Comprehensive plans to reduce emissions and to prepare for climate change are not yet in place. Strong policies from across government are needed to reduce our vulnerability to the destructive risks of climate change and to avoid a disorderly transition to net-zero. Business must also play its part, including through full disclosure of climate risks. Plans must be implemented alongside the medium-term response to COVID-19 and will bring benefits to health, well-being and national security.",
    //   //         "category": "Adaptation",
    //   //           "specific": "Reduce resilience deficit"
    // })


    jQuery.getJSON('./flare.json', function (data) {

      const root = partition(data);
      const color = d3.scaleOrdinal().range(d3.quantize(d3.interpolateRainbow, data.children.length + 1));

      root.each(d => d.current = d);

      const svg = d3.select('#partitionSVG')
        .style("font", "18px sans-serif;font-weight:bold");

      const g = svg.append("g")
        .attr("transform", `translate(${width / 2},${width / 2})`);

      const path = g.append("g")
        .selectAll("path")
        .data(root.descendants().slice(1))
        .join("path")
        .attr("fill", d => {
          while (d.depth > 1)
            d = d.parent;
          return color(d.data.name);
        })
        .attr("fill-opacity", d => arcblock(d.current) ? (d.children ? 0.6 : 0.4) : 0)
        .attr("d", d => arc(d.current)).on("mouseover", function (d) {
          var e = window.event;

          if (d.data.data?.text) {
            jQuery('#modal .text').html(d.data.data?.text);
            jQuery('#modal .heading').html(d.data.data?.heading);
            jQuery('#modal .score').html(d.data.data?.score);
            jQuery('#modal .recommendation').html(d.data.data?.recommendation);

            jQuery('#modal .link').html(d.data.data?.link?.text);
            jQuery('#modal .link').attr('href', d.data.data?.link?.href);
            jQuery('#modal').css('opacity', '1');
            // jQuery('#modal').css('right', e.pageX - 200)
            // jQuery('#modal').css('top', e.pageY)

            jQuery('#modal').css('display', 'block');

          } else {
            jQuery('#modal').css('opacity', '0')
            jQuery('#modal').css('display', 'none');

            jQuery('#modal .text').html('');
            jQuery('#modal .heading').html('');
            jQuery('#modal .link').html('');

          }

        });;

      path.filter(d => d.children)
        .style("cursor", "pointer")
        .on("click", clicked).on("mouseover", function (d) {

          var e = window.event;

          if (d.data.data?.text) {
            jQuery('#modal .text').html(d.data.data?.text);
            jQuery('#modal .heading').html(d.data.data?.heading);
            jQuery('#modal .score').html(d.data.data?.score);
            jQuery('#modal .recommendation').html(d.data.data?.recommendation);
            jQuery('#modal .link').html(d.data.data?.link?.text);
            jQuery('#modal .link').attr('href', d.data.data?.link?.href);
            jQuery('#modal').css('opacity', '1');

            jQuery('#modal').css('display', 'block');


          } else {
            jQuery('#modal').css('opacity', '0')
            jQuery('#modal').css('display', 'none');

            jQuery('#modal .text').html('');
            jQuery('#modal .heading').html('');
            jQuery('#modal .link').html('');

          }
        });
      // .on("mouseleave", function () {
      //   jQuery('#modal p').html('hello world');
      //   jQuery('#modal').css('display', '');
      //   jQuery('#modal').css('opacity', '0');
      // });    
      path.append("text").attr('x', '20').attr('y', '45').append('tspan')
        .text(d => d.data.details !== undefined ? d.data.details : `${d.ancestors().map(d =>
          d.data.details !== undefined ? d.data.details + "\\n" : d.data.name
        )}`).attr('x', '20').attr('y', '75').attr('font', 'font: 24px sans-serif; inline-size: 250px;');

      function chunkSubstr(str, size) {
        size = Math.round(size)
        console.log(str, Math.round(size))
        if (str == null) return [];
        str = String(str);
        console.log(size > 0 ? str.match(new RegExp('.{1,' + size + '}', 'g')) : [str])
        return size > 0 ? str.match(new RegExp('.{1,' + size + '}', 'g')) : [str];
      }


      function formhtml(d) {
        var html = "";

        // <tspan dy='1em'  x='0'>Sunset Park</tspan><tspan  x='0' dy='1.2em'>-- Patrick Phillips</tspan> <tspan dy='1.3em'  x='0'>The Chinese truck driver</tspan>
        if (d.data.name.length > 18) {
          var count = 0;
          var dy = -1;
          chunkSubstr(d.data.name, 15).map(single => {
            html += "<tspan dy='" + dy + "." + count + "9em'  x='0'>" + single + "</tspan>";
            dy = 1;
            count += 1;

          })
          return html;
        } else {
          return d.data.name;
        }
      }

      const label = g.append("g")
        .attr("pointer-events", "none")
        .attr("text-anchor", "middle")
        .style("user-select", "none")
        .selectAll("text")
        .data(root.descendants().slice(1))
        .join("text")
        .attr("dy", "0.35em")
        .attr('font-size', '16px')
        .attr("fill-opacity", d => +labelblock(d.current))
        .attr("transform", d => labelTransform(d.current))
        .html(d => formhtml(d)).attr('inline-size', '10px');

      //       <text x="0" y="0">
      //   <tspan x="0" dy="1em">very long text</tspan>
      //   <tspan x="0" dy="1.2em">I would like to linebreak</tspan>
      // </text>
      const parent = g.append("circle")
        .datum(root)
        .attr("r", radius)
        .attr("fill", "none")
        .attr("pointer-events", "all")
        .on("click", clicked);

      function clicked(p) {
        // console.log(jQuery(this).children('title').html())
        parent.datum(p.parent || root);

        root.each(d => d.target = {
          x0: Math.max(0, Math.min(1, (d.x0 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
          x1: Math.max(0, Math.min(1, (d.x1 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
          y0: Math.max(0, d.y0 - p.depth),
          y1: Math.max(0, d.y1 - p.depth)
        });

        const t = g.transition().duration(750);

        // Transition the data on all arcs, even the ones that aren’t block,
        // so that if this transition is interrupted, entering arcs will start
        // the next transition from the desired position.
        path.transition(t)
          .tween("data", d => {
            const i = d3.interpolate(d.current, d.target);
            return t => d.current = i(t);
          })
          .filter(function (d) {
            return +this.getAttribute("fill-opacity") || arcblock(d.target);
          })
          .attr("fill-opacity", d => arcblock(d.target) ? (d.children ? 0.6 : 0.4) : 0)
          .attrTween("d", d => () => arc(d.current));

        label.filter(function (d) {
          return +this.getAttribute("fill-opacity") || labelblock(d.target);
        }).transition(t)
          .attr("fill-opacity", d => +labelblock(d.target))
          .attrTween("transform", d => () => labelTransform(d.current));
      }

      function arcblock(d) {
        return d.y1 <= 3 && d.y0 >= 1 && d.x1 > d.x0;
      }

      function labelblock(d) {
        return d.y1 <= 3 && d.y0 >= 1 && (d.y1 - d.y0) * (d.x1 - d.x0) > 0.03;
      }

      function labelTransform(d) {
        const x = (d.x0 + d.x1) / 2 * 180 / Math.PI;
        const y = (d.y0 + d.y1) / 2 * radius;
        return `rotate(${x - 90}) translate(${y},0) rotate(${x < 180 ? 0 : 180})`;
      }
    });


    jQuery('.modal__close').on('click', function () {
      jQuery('#modal').css('opacity', '0')
      jQuery('#modal').css('display', 'none');

    })
  </script>
</body>